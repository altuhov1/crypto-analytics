<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Выбор криптовалютных пар - CoinSight</title>
    <link rel="icon" type="image/x-icon" href="/static/images/favicon.ico">
    <link rel="icon" type="image/png" href="/static/images/favicon.png">
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/crypto_pairs.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>
    <header class="header">
        <div class="container">
            <h1 class="logo">
                <a href="/"
                    style="font-family: 'Montserrat', sans-serif; font-weight: 600; letter-spacing: -0.5px; font-size: 1.8rem; text-decoration: none; color: var(--accent-color);">CoinSight</a>
            </h1>

            <!-- Кнопка бургер-меню -->
            <button class="burger-menu" id="burger-menu" aria-label="Открыть меню">
                <span></span>
                <span></span>
                <span></span>
            </button>

            <nav class="nav" id="main-nav">
                <a href="/">Главная</a>
                <a href="/crypto-top">Топ криптовалют</a>
            </nav>

            <!-- Оверлей для затемнения фона -->
            <div class="nav-overlay" id="nav-overlay"></div>
        </div>
    </header>

    <div class="pairs-container">
        <h1>Выбор криптовалютных пар</h1>
        <p style="color: var(--text-secondary); margin-bottom: 30px;">
            Найдите и выберите торговую пару для отправки на анализ
        </p>

        <div class="search-section">
            <input type="text" id="searchBox" class="search-box"
                placeholder="Введите название пары (например: BTC, ETH, ADA)...">

            <div class="popular-pairs">
                <div class="popular-pair" data-pair="BTCUSDT">BTC/USDT</div>
                <div class="popular-pair" data-pair="ETHUSDT">ETH/USDT</div>
                <div class="popular-pair" data-pair="ADAUSDT">ADA/USDT</div>
                <div class="popular-pair" data-pair="DOTUSDT">DOT/USDT</div>
                <div class="popular-pair" data-pair="LINKUSDT">LINK/USDT</div>
            </div>

            <div class="results-count" id="resultsCount">
                Загрузка пар...
            </div>

            <div class="search-results" id="searchResults">
                <div class="no-results">
                    <div class="loading" style="margin: 0 auto 15px;"></div>
                    <p>Загрузка списка пар...</p>
                </div>
            </div>
        </div>

        <div class="selected-pair-section" id="selectedPairSection" style="display: none;">
            <div class="selected-pair" id="selectedPairDisplay"></div>
            <p>Выбранная пара будет отправлена на внешний сервис для анализа</p>

            <div class="action-buttons">
                <button id="sendBtn" class="send-btn">
                    Отправить на анализ
                </button>
                <button id="clearBtn" class="clear-btn">
                    <i class="fas fa-times"></i>
                    Очистить выбор
                </button>
            </div>

            <div id="statusMessage" class="status-message" style="display: none;"></div>
        </div>

        <a href="/" class="back-link">← Вернуться на главную</a>
    </div>

    <script>
        let allPairs = [];
        let selectedPair = null;
        let searchTimeout = null;

        // Элементы DOM
        const searchBox = document.getElementById('searchBox');
        const searchResults = document.getElementById('searchResults');
        const resultsCount = document.getElementById('resultsCount');
        const selectedPairSection = document.getElementById('selectedPairSection');
        const selectedPairDisplay = document.getElementById('selectedPairDisplay');
        const sendBtn = document.getElementById('sendBtn');
        const clearBtn = document.getElementById('clearBtn');
        const statusMessage = document.getElementById('statusMessage');

        // Загрузка всех пар при старте
        document.addEventListener('DOMContentLoaded', async function () {
            // Инициализация бургер-меню
            initBurgerMenu();

            await loadAllPairs();
            setupEventListeners();
        });

        // Функционал бургер-меню
        function initBurgerMenu() {
            const burgerMenu = document.getElementById('burger-menu');
            const mainNav = document.getElementById('main-nav');
            const navOverlay = document.getElementById('nav-overlay');

            if (burgerMenu && mainNav && navOverlay) {
                burgerMenu.addEventListener('click', function (e) {
                    e.stopPropagation();
                    this.classList.toggle('active');
                    mainNav.classList.toggle('active');
                    navOverlay.classList.toggle('active');
                });

                navOverlay.addEventListener('click', function () {
                    burgerMenu.classList.remove('active');
                    mainNav.classList.remove('active');
                    this.classList.remove('active');
                });

                const navLinks = mainNav.querySelectorAll('a');
                navLinks.forEach(link => {
                    link.addEventListener('click', () => {
                        burgerMenu.classList.remove('active');
                        mainNav.classList.remove('active');
                        navOverlay.classList.remove('active');
                    });
                });

                window.addEventListener('resize', () => {
                    if (window.innerWidth > 768) {
                        burgerMenu.classList.remove('active');
                        mainNav.classList.remove('active');
                        navOverlay.classList.remove('active');
                    }
                });
            }
        }

        // Загрузка всех пар с сервера
        async function loadAllPairs() {
            try {
                showLoading('Загрузка списка пар...');

                const response = await fetch('/api/all-pairs');
                const data = await response.json();

                if (data.success) {
                    allPairs = data.pairs;
                    showInitialState();
                    console.log(`Loaded ${allPairs.length} pairs`);
                } else {
                    showError('Ошибка при загрузке пар: ' + data.error);
                }
            } catch (error) {
                console.error('Load pairs error:', error);
                showError('Ошибка при загрузке списка пар');
            }
        }

        // Настройка обработчиков событий
        function setupEventListeners() {
            // Поиск при вводе
            searchBox.addEventListener('input', function () {
                const query = this.value.trim().toUpperCase();

                if (searchTimeout) {
                    clearTimeout(searchTimeout);
                }

                searchTimeout = setTimeout(() => {
                    searchPairs(query);
                }, 100);
            });

            // Популярные пары
            document.querySelectorAll('.popular-pair').forEach(pair => {
                pair.addEventListener('click', function () {
                    selectPair(this.dataset.pair);
                    searchBox.value = '';
                    showInitialState();
                });
            });

            // Очистка выбора
            clearBtn.addEventListener('click', clearSelection);

            // Отправка пары
            sendBtn.addEventListener('click', sendSelectedPair);
        }

        // Поиск пар (клиентский)
        function searchPairs(query) {
            if (!query) {
                showInitialState();
                return;
            }

            const filteredPairs = allPairs.filter(pair =>
                pair.includes(query)
            );

            displayPairs(filteredPairs, query);
        }

        // Отображение состояния загрузки
        function showLoading(message) {
            searchResults.innerHTML = `
                <div class="no-results">
                    <div class="loading" style="margin: 0 auto 15px;"></div>
                    <p>${message}</p>
                </div>
            `;
            resultsCount.textContent = message;
        }

        // Отображение начального состояния
        function showInitialState() {
            const initialPairs = allPairs.slice(0, 20);
            displayPairs(initialPairs, '');
            resultsCount.textContent = `Всего пар: ${allPairs.length}. Введите текст для поиска`;
        }

        // Отображение ошибки
        function showError(message) {
            searchResults.innerHTML = `
                <div class="no-results">
                    <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 10px; color: var(--error-color);"></i>
                    <p>${message}</p>
                </div>
            `;
            resultsCount.textContent = 'Ошибка загрузки';
        }

        // Отображение найденных пар
        function displayPairs(pairs, query) {
            if (pairs.length === 0) {
                searchResults.innerHTML = `
            <div class="no-results">
                <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.5;"></i>
                <p>Пар не найдено для "${query}"</p>
            </div>
        `;
                resultsCount.textContent = `Найдено пар: 0`;
                return;
            }

            const pairsHtml = pairs.map(pair => {
                const isSelected = selectedPair === pair;

                return `
            <div class="pair-item ${isSelected ? 'selected' : ''}" data-pair="${pair}">
                <span class="pair-symbol">${pair}</span>
                <button class="select-btn" ${isSelected ? 'disabled' : ''}>
                    ${isSelected ? '✓ Выбрано' : 'Выбрать'}
                </button>
            </div>
        `;
            }).join('');

            searchResults.innerHTML = pairsHtml;
            resultsCount.textContent = `Найдено пар: ${pairs.length}${query ? ` для "${query}"` : ''}`;

            document.querySelectorAll('.pair-item').forEach(item => {
                item.addEventListener('click', function () {
                    selectPair(this.dataset.pair);
                });
            });
        }

        // Выбор пары
        function selectPair(pair) {
            selectedPair = pair;
            selectedPairDisplay.textContent = pair;
            selectedPairSection.style.display = 'block';
            updateSelectionInResults();
            selectedPairSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Обновление выбора в результатах
        function updateSelectionInResults() {
            document.querySelectorAll('.pair-item').forEach(item => {
                if (item.dataset.pair === selectedPair) {
                    item.classList.add('selected');
                    item.querySelector('.select-btn').textContent = '✓ Выбрано';
                    item.querySelector('.select-btn').disabled = true;
                } else {
                    item.classList.remove('selected');
                    item.querySelector('.select-btn').textContent = 'Выбрать';
                    item.querySelector('.select-btn').disabled = false;
                }
            });
        }

        // Очистка выбора
        function clearSelection() {
            selectedPair = null;
            selectedPairSection.style.display = 'none';
            statusMessage.style.display = 'none';

            document.querySelectorAll('.pair-item').forEach(item => {
                item.classList.remove('selected');
                item.querySelector('.select-btn').textContent = 'Выбрать';
                item.querySelector('.select-btn').disabled = false;
            });
        }

        // Отправка пары на бэкенд
        async function sendSelectedPair() {
            if (!selectedPair) return;

            try {
                sendBtn.innerHTML = '<div class="loading"></div> Отправка...';
                sendBtn.disabled = true;
                statusMessage.style.display = 'none';

                const response = await fetch('/api/select-pair', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        pair: selectedPair
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showStatus(data.message, 'success');
                } else {
                    showStatus('Ошибка: ' + (data.error || data.message), 'error');
                }
            } catch (error) {
                console.error('Send error:', error);
                showStatus('Ошибка при отправке: ' + error.message, 'error');
            } finally {
                sendBtn.innerHTML = 'Отправить на анализ';
                sendBtn.disabled = false;
            }
        }

        // Показать статус
        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status-message status-${type}`;
            statusMessage.style.display = 'block';
        }
    </script>
</body>

</html>